#!/command/with-contenv sh
# shellcheck shell=sh

set -eu

. /usr/local/bin/backend-functions

SCRIPT_NAME="SERVICE-NORDVPN"

log "$SCRIPT_NAME" "Starting NordVPN service"

vpn-config

# -------- parse the single 'Endpoint' line --------
endpoint_line="$(awk '/^[[:space:]]*Endpoint[ \t]*=/ {print; exit}' "$wgfile")"
[ -n "$endpoint_line" ] || { log_error "$SCRIPT_NAME" "CRITICAL: No 'Endpoint' line in $wgfile"; sleep infinity; }

endpoint_value="$(echo "$endpoint_line" | sed 's/.*= *//' | sed 's/^[[:space:]]*//' | sed 's/[[:space:]]*$//')"
r_ip_raw="$(echo "$endpoint_value" | cut -d: -f1)"
# Clean up any bracketed IPv6 (just in case)
r_ip="$(echo "$r_ip_raw" | sed 's,^\[,,' | sed 's,\]$,,' )"

# -------- add a single temporary pinhole on eth0 --------

PIN_SPEC="-A VPN-SERVER -o eth0 -d ${r_ip} -j ACCEPT"
if run4 $PIN_SPEC 2>/dev/null; then
    log "$SCRIPT_NAME" "Pinhole added: $IPT $PIN_SPEC"
fi

log "$SCRIPT_NAME" "Launching WireGuard..."
wg-quick down wg0 || true
wg-quick up wg0

# Wait for VPN connection
log "$SCRIPT_NAME" "Waiting for VPN connection..."
counter=0
while ! is_vpn_connected && [ $counter -lt 30 ]; do
    sleep 2
    counter=$((counter + 1))
done

if is_vpn_connected; then
    log "$SCRIPT_NAME" "VPN connected successfully"
    # Run network diagnostic if enabled
    if [ "$network_diagnostic_enabled" = "true" ] || [ "$network_diagnostic_enabled" = "1" ]; then
        log "$SCRIPT_NAME" "Running network diagnostic..."
        network-diagnostic
    fi
else
    log "$SCRIPT_NAME" "VPN connection timeout"
fi

# Keep the s6 service running indefinitely
sleep infinity

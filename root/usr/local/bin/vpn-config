#!/command/with-contenv sh
# shellcheck shell=sh

set -eu

echo "[VPN-CONFIG] Starting vpn-config script..."

# Set default values for environment variables
COUNTRY="${COUNTRY:-}"
CITY="${CITY:-}"
GROUP="${GROUP:-}"
RANDOM_TOP="${RANDOM_TOP:-0}"

numericregex="^[0-9]+$"
specific_server_regex="^[a-zA-Z]{2}[0-9]+$"

wgfile="/etc/wireguard/wg0.conf"

# Helper functions for pattern matching (sh-compatible)
is_numeric()
{
    case "$1" in
        ''|*[!0-9]*) return 1 ;;
        *) return 0 ;;
    esac
}

is_specific_server()
{
    case "$1" in
        [a-zA-Z][a-zA-Z][0-9]*)
            # Check if it's exactly 2 letters followed by numbers
            prefix=$(echo "$1" | cut -c1-2)
            suffix=$(echo "$1" | cut -c3-)
            case "$prefix" in
                [a-zA-Z][a-zA-Z]) ;;
                *) return 1 ;;
            esac
            case "$suffix" in
                ''|*[!0-9]*) return 1 ;;
                *) return 0 ;;
            esac
            ;;
        *) return 1 ;;
    esac
}

contains_substring()
{
    case "$1" in
        *"$2"*) return 0 ;;
        *) return 1 ;;
    esac
}

getcountryid()
{
    input=$1

    if is_numeric "$input"; then
        id=$(jq -r --argjson ID "$input" 'select(.id == $ID) | .id' < "/etc/nordvpn/countries.json")
    else
        id=$(jq -r --arg NAME "$input" 'select(.name == $NAME) | .id' < "/etc/nordvpn/countries.json")
        if [ -z "$id" ]; then
            id=$(jq -r --arg CODE "$input" 'select(.code == $CODE) | .id' < "/etc/nordvpn/countries.json")
        fi
    fi

    printf '%s' "$id"

    if [ -z "$id" ]; then
        return 1
    fi

    return 0
}

getcountryname()
{
    input=$1

    if is_numeric "$input"; then
        name=$(jq -r --argjson ID "$input" 'select(.id == $ID) | .name' < "/etc/nordvpn/countries.json")
    else
        name=$(jq -r --arg NAME "$input" 'select(.name == $NAME) | .name' < "/etc/nordvpn/countries.json")
        if [ -z "$name" ]; then
            name=$(jq -r --arg CODE "$input" 'select(.code == $CODE) | .name' < "/etc/nordvpn/countries.json")
        fi
    fi

    printf '%s' "$name"

    if [ -z "$name" ]; then
        return 1
    fi

    return 0
}

getcityid()
{
    input=$1

    if is_numeric "$input"; then
        id=$(jq -r --argjson ID "$input" 'select(.cities[]? | .id == $ID) | .cities[] | select(.id == $ID) | .id' < "/etc/nordvpn/countries.json" | head -n 1)
    else
        id=$(jq -r --arg NAME "$input" 'select(.cities[]? | .name == $NAME) | .cities[] | select(.name == $NAME) | .id' < "/etc/nordvpn/countries.json" | head -n 1)
        if [ -z "$id" ]; then
            id=$(jq -r --arg DNS_NAME "$input" 'select(.cities[]? | .dns_name == $DNS_NAME) | .cities[] | select(.dns_name == $DNS_NAME) | .id' < "/etc/nordvpn/countries.json" | head -n 1)
        fi
    fi

    printf '%s' "$id"

    if [ -z "$id" ]; then
        return 1
    fi

    return 0
}

getcityname()
{
    input=$1

    if is_numeric "$input"; then
        name=$(jq -r --argjson ID "$input" 'select(.cities[]? | .id == $ID) | .cities[] | select(.id == $ID) | .name' < "/etc/nordvpn/countries.json" | head -n 1)
    else
        name=$(jq -r --arg NAME "$input" 'select(.cities[]? | .name == $NAME) | .cities[] | select(.name == $NAME) | .name' < "/etc/nordvpn/countries.json" | head -n 1)
        if [ -z "$name" ]; then
            name=$(jq -r --arg DNS_NAME "$input" 'select(.cities[]? | .dns_name == $DNS_NAME) | .cities[] | select(.dns_name == $DNS_NAME) | .name' < "/etc/nordvpn/countries.json" | head -n 1)
        fi
    fi

    printf '%s' "$name"

    if [ -z "$name" ]; then
        return 1
    fi

    return 0
}

getcitycoordinates()
{
    input=$1

    # First get the city ID using existing function
    cityid=$(getcityid "$input")
    if [ -z "$cityid" ]; then
        return 1
    fi

    # Then get coordinates using the city ID
    coords=$(jq -r --argjson ID "$cityid" 'select(.cities[]? | .id == $ID) | .cities[] | select(.id == $ID) | "\(.latitude),\(.longitude)"' < "/etc/nordvpn/countries.json" | head -n 1)

    printf '%s' "$coords"

    if [ -z "$coords" ] || [ "$coords" = "null,null" ]; then
        return 1
    fi

    return 0
}

getgroupid()
{
    input=$1

    # Check for empty input
    if [ -z "$input" ]; then
        return 1
    fi

    if is_numeric "$input"; then
        id=$(jq -r --argjson ID "$input" 'select(.id == $ID) | .id' < "/etc/nordvpn/groups.json")
    else
        id=$(jq -r --arg TITLE "$input" 'select(.title == $TITLE) | .id' < "/etc/nordvpn/groups.json")
        if [ -z "$id" ]; then
            id=$(jq -r --arg IDENTIFIER "$input" 'select(.identifier == $IDENTIFIER) | .id' < "/etc/nordvpn/groups.json")
        fi
    fi

    printf '%s' "$id"

    if [ -z "$id" ]; then
        return 1
    fi

    return 0
}

getgrouptitle()
{
    input=$1

    if is_numeric "$input"; then
        title=$(jq -r --argjson ID "$input" 'select(.id == $ID) | .title' < "/etc/nordvpn/groups.json")
    else
        title=$(jq -r --arg TITLE "$input" 'select(.title == $TITLE) | .title' < "/etc/nordvpn/groups.json")
        if [ -z "$title" ]; then
            title=$(jq -r --arg IDENTIFIER "$input" 'select(.identifier == $IDENTIFIER) | .title' < "/etc/nordvpn/groups.json")
        fi
    fi

    printf '%s' "$title"

    if [ -z "$title" ]; then
        return 1
    fi

    return 0
}

handle_specific_server()
{
    value=$1
    
    # Convert to lowercase using tr instead of ${value,,}
    hostname="$(echo "$value" | tr '[:upper:]' '[:lower:]').nordvpn.com"
    ip="$(host -t A "$hostname" | awk '{print $4}')"
    # Extract country code (first 2 chars) and number part
    country_code=$(echo "$value" | cut -c1-2)
    country_num=$(echo "$value" | cut -c3-)
    name="$(getcountryname "$country_code") #$country_num"
    constructed_json=$(printf '{"name":"%s","hostname":"%s","load":0,"station":"%s"}' "$name" "$hostname" "$ip")
    
    printf '%s' "$constructed_json"
}

nord_api_curl()
{
    _path="$1"
    shift 2>/dev/null || true

    oldIFS="$IFS"; IFS=',;'; _rc=1
    for _ip in $NORDVPNAPI_IP; do
        [ -n "$_ip" ] || continue

        curl -sG --connect-timeout 10 --max-time 30 \
             --resolve "api.nordvpn.com:443:${_ip}" \
             "https://api.nordvpn.com/${_path}" "$@"
        _rc=$?
        [ $_rc -eq 0 ] && IFS="$oldIFS" && return 0
    done
    IFS="$oldIFS"
    return $_rc
}

servers=""
locations_count=0

tech_filter="--data-urlencode filters[servers_technologies][id]=35"

# Validate group IDs and build filter strings
group_filter=""
if [ -n "$GROUP" ]; then
    group_id=$(getgroupid "$GROUP")
    if [ -z "$group_id" ]; then
        echo "[VPN-CONFIG] Warning: Could not find group \"$GROUP\""
    else
        group_filter="--data-urlencode filters[servers_groups][id]=$group_id"
    fi
else
    echo "[VPN-CONFIG] No group filter specified"
fi

test_response=$(nord_api_curl "v1/servers/recommendations" --data-urlencode "limit=1" 2>/dev/null || echo "")
if [ -z "$test_response" ]; then
    echo "[VPN-CONFIG] WARNING: API connectivity test failed - no response from NordVPN API"
fi
servers=""
locations_count=0

# Process COUNTRY if set
if [ -n "$COUNTRY" ]; then
    # Convert semicolon/comma separated list to space separated
    oldIFS="$IFS"; IFS=',;'; _rc=1
    for value in $COUNTRY; do
        if [ -n "$value" ]; then
            locations_count=$((locations_count + 1))
        fi
        if is_specific_server "$value"; then
            servers="$servers$(handle_specific_server "$value")"
        elif [ -n "$value" ]; then
            countryid=$(getcountryid "$value")
            if [ -n "$countryid" ]; then
                # Build curl parameters
                curl_params="$tech_filter --data-urlencode filters[country_id]=$countryid"
                if [ -n "$group_filter" ]; then
                    curl_params="$curl_params $group_filter"
                fi
                
                # Execute curl with built parameters
                serversincountry=$(eval "nord_api_curl \"v1/servers/recommendations\" $curl_params 2>/dev/null | jq -c '.[]' 2>/dev/null || echo \"\"")
                if [ -n "$serversincountry" ]; then
                    echo "[VPN-CONFIG] Request servers in \"$(getcountryname "$value")\", $(echo "$serversincountry" | jq -s 'length') servers received"
                    echo "$serversincountry" | jq -r '[.name, .hostname, .load, .locations[0].country.name, .locations[0].country.city.name] | "\(.[1]): \(.[2])% load - \(.[3]), \(.[4]) (\(.[0]))"'
                    servers="$servers""$serversincountry"
                else
                    echo "[VPN-CONFIG] Warning: No servers returned for country \"$value\""
                fi
            else
                echo "[VPN-CONFIG] Warning: Could not find country \"$value\""
            fi
        fi
    done
    IFS="$oldIFS"
fi

# Process CITY if set
if [ -n "$CITY" ]; then
    # Convert semicolon/comma separated list to space separated
    oldIFS="$IFS"; IFS=',;'
    for value in $CITY; do
        if [ -n "$value" ]; then
            locations_count=$((locations_count + 1))
        fi
        if is_specific_server "$value" ]; then
            servers="$servers$(handle_specific_server "$value")"
        elif [ -n "$value" ]; then
            coords=$(getcitycoordinates "$value")
            if [ -n "$coords" ]; then
                latitude=$(echo "$coords" | cut -d',' -f1)
                longitude=$(echo "$coords" | cut -d',' -f2)
                
                # Build curl parameters
                curl_params="$tech_filter --data-urlencode coordinates[latitude]=$latitude --data-urlencode coordinates[longitude]=$longitude"
                if [ -n "$group_filter" ]; then
                    curl_params="$curl_params $group_filter"
                fi
                
                # Execute curl with built parameters
                serversincity=$(eval "nord_api_curl \"v1/servers/recommendations\" $curl_params 2>/dev/null | jq -c '.[]' 2>/dev/null || echo \"\"")
                if [ -n "$serversincity" ]; then
                    echo "[VPN-CONFIG] Request servers in \"$(getcityname "$value")\", $(echo "$serversincity" | jq -s 'length') servers received"
                    echo "$serversincity" | jq -r '[.name, .hostname, .load, .locations[0].country.name, .locations[0].country.city.name] | "\(.[1]): \(.[2])% load - \(.[3]), \(.[4]) (\(.[0]))"'
                    servers="$servers""$serversincity"
                else
                    echo "[VPN-CONFIG] Warning: No servers returned for city \"$value\""
                fi
            else
                echo "[VPN-CONFIG] Warning: Could not find coordinates for city \"$value\""
            fi
        fi
    done
    IFS="$oldIFS"
fi

poollength=0
if [ -n "$servers" ]; then
    poollength=$(echo "$servers" | jq -s 'unique | length' 2>/dev/null || echo "0")
else
    echo "[VPN-CONFIG] No servers collected from any sources"
fi

# If no servers found, fallback to default recommended servers
if [ "$poollength" -eq 0 ]; then
    echo "[VPN-CONFIG] No servers found for specified criteria, requesting default recommended servers"
    
    # Build curl parameters for fallback
    curl_params="$tech_filter"
    if [ -n "$group_filter" ]; then
        curl_params="$curl_params $group_filter"
    fi
    
    servers=$(eval "nord_api_curl \"v1/servers/recommendations\" $curl_params 2>/dev/null | jq -c '.[]' 2>/dev/null || echo \"\"")
    
    if [ -n "$servers" ]; then
        echo "[VPN-CONFIG] Default recommended servers: $(echo "$servers" | jq -s 'length') servers received"
        echo "$servers" | jq -r '[.name, .hostname, .load, .locations[0].country.name, .locations[0].country.city.name] | "\(.[1]): \(.[2])% load - \(.[3]), \(.[4]) (\(.[0]))"'
        poollength=$(echo "$servers" | jq -s 'unique | length')
    else
        echo "[VPN-CONFIG] CRITICAL ERROR: Failed to get fallback servers - sleeping infinite"
        sleep infinity
    fi
fi

# Only sort by load if multiple locations are specified, otherwise keep recommended order
if [ \( -n "$COUNTRY" \) -o \( -n "$CITY" \) ] && [ "$locations_count" -gt 1 ] && [ "$poollength" -gt 0 ]; then
    # Multiple locations - sort by load and remove duplicates
    servers=$(echo "$servers" | jq -s -c 'unique | sort_by(.load) | .[]')
else
    # Single location or no location specified - keep recommended order as is
    servers=$(echo "$servers" | jq -s -c '.[]')
fi

if [ "$RANDOM_TOP" -ne 0 ]; then
    if [ "$RANDOM_TOP" -lt "$poollength" ]; then
        filtered=$(echo "$servers" | head -n "$RANDOM_TOP" | shuf)
        servers="$filtered"$(echo "$servers" | tail -n +"$((RANDOM_TOP + 1))")
    else
        servers=$(echo "$servers" | shuf)
    fi
fi

echo "[VPN-CONFIG] $poollength recommended servers in pool"
if [ "$poollength" -ne 0 ]; then
    echo "[VPN-CONFIG] --- Top 20 servers in filtered pool ---"
    echo "$servers" | jq -r '[.name, .hostname, .load, .locations[0].country.name, .locations[0].country.city.name] | "\(.[1]): \(.[2])% load - \(.[3]), \(.[4]) (\(.[0]))"' | head -n 20
    echo "[VPN-CONFIG] ---------------------------------------"
fi

if [ "$poollength" -eq 0 ]; then
    echo "[VPN-CONFIG] CRITICAL ERROR: list of selected servers is empty - sleeping infinite"
    sleep infinity
fi

serverip=$(echo "$servers" | jq -r '.station' | head -n 1)
name=$(echo "$servers" | jq -r '.name' | head -n 1)
hostname=$(echo "$servers" | jq -r '.hostname' | head -n 1)
serverkey=$(echo "$servers" | jq -r '.technologies[] | select(.id == 35) | .metadata[] | select(.name == "public_key") | .value' | head -n 1)

# Extract location information
country_name=$(echo "$servers" | jq -r '.locations[0].country.name' | head -n 1)
city_name=$(echo "$servers" | jq -r '.locations[0].country.city.name' | head -n 1)
echo "[VPN-CONFIG] Select server \"$name\" hostname=\"$hostname\" ip=\"$serverip\" protocol=\"udp\" location=\"$country_name, $city_name\""

if [ -z "$serverkey" ] || [ "$serverkey" = "null" ]; then
    echo "[VPN-CONFIG] CRITICAL ERROR: Could not extract WireGuard public key from server data - sleeping infinite"
    sleep infinity
fi

# Set file permissions so only the owner can read/write the config file
umask 077

# Create and write WireGuard VPN configuration to /etc/wireguard/wg0.conf
{
    echo "# Local network interface configuration"
    echo "[Interface]"
    echo "PrivateKey = ${PRIVATE_KEY}"                # Your private key
    echo "ListenPort = ${LISTEN_PORT:-51820}"         # Port for WireGuard (default: 51820)
    echo "Address = ${ADDRESS:-10.5.0.2/32}"          # Local VPN IP address (default: 10.5.0.2/32)
    echo "DNS = ${DNS}"                               # Default DNS servers for VPN
    echo "Table = ${TABLE:-}"                         # Optional routing table
    echo "PreUp = ${PRE_UP:-}"                        # Script to run before interface is up
    echo "PostUp = ${POST_UP:-}"                      # Script to run after interface is up
    echo "PreDown = ${PRE_DOWN:-}"                    # Script to run before interface is down
    echo "PostDown = ${POST_DOWN:-}"                  # Script to run after interface is down
    echo ""
    echo "# Remote peer configuration"
    echo "[Peer]"
    echo "# Server: ${hostname}"
    echo "Endpoint = ${serverip}:51820"               # Peer address and port
    echo "PublicKey = ${serverkey}"                   # Peer public key
    echo "AllowedIPs = ${ALLOWED_IPS:-0.0.0.0/0}"     # Allowed IPs via VPN (default: everything)
    echo "PersistentKeepalive = ${PERSISTENT_KEEP_ALIVE:-25}" # Keepalive interval (default: 25 seconds)
} > "$wgfile"

# Flush filesystem buffers to disk to ensure changes are saved
sync

# Verify the config file was created successfully
if [ ! -s "$wgfile" ]; then
    echo "[VPN-CONFIG] CRITICAL ERROR: VPN config file was not created successfully - sleeping infinite"
    sleep infinity
fi

echo "[VPN-CONFIG] vpn-config script completed successfully"
exit 0
#!/command/with-contenv sh
# shellcheck shell=sh

set -eu

. /usr/local/bin/backend-functions

SCRIPT_NAME="VPN-HEALTHCHECK"

log "$SCRIPT_NAME" "Starting VPN health check"

httpreq()
{
    case "$(curl -s --max-time 2 -I "$1" | sed 's/^[^ ]*  *\([0-9]\).*/\1/; 1q')" in
        [23]) return 0;;
        5) return 1;;
        *) return 1;;
    esac
}

counter=1
while [ $counter -le "$check_connection_attempts" ]; do
    # Convert semicolon separated list to space separated
    oldIFS="$IFS"; IFS=',;'
    for url in $check_connection_url; do
        if httpreq "$url"; then
            log "$SCRIPT_NAME" "VPN connection is active"
            exit 0
        fi
    done
    IFS="$oldIFS"

    log "$SCRIPT_NAME" "Connection attempt $counter/$check_connection_attempts failed, retrying in $check_connection_attempt_interval seconds"
    sleep "$check_connection_attempt_interval"
    counter=$((counter + 1))
done

log "$SCRIPT_NAME" "All connection attempts failed, triggering VPN reconnection"
vpn-reconnect
exit 1
